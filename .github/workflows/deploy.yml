name: Deploy to App Stores

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - ios
          - android
          - both
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'build'
        type: choice
        options:
          - build    # Only increment build number (1.0.7+26 -> 1.0.7+27)
          - patch    # Increment patch version (1.0.7+26 -> 1.0.8+27)
          - minor    # Increment minor version (1.0.7+26 -> 1.1.0+27)
          - major    # Increment major version (1.0.7+26 -> 2.0.0+27)
      track:
        description: 'Release track'
        required: true
        default: 'beta'
        type: choice
        options:
          - internal  # Internal testing (Android) / TestFlight (iOS)
          - beta      # Beta/Closed testing
          - production

env:
  FLUTTER_VERSION: '3.29.0'
  RUBY_VERSION: '3.4.0'

jobs:
  version-bump:
    name: Bump Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      build_number: ${{ steps.bump.outputs.build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          # Read current version from pubspec.yaml
          current_version=$(grep -E '^version:' pubspec.yaml | sed 's/version: //')
          echo "Current version: $current_version"

          # Parse version and build number
          version_name=$(echo $current_version | cut -d'+' -f1)
          build_number=$(echo $current_version | cut -d'+' -f2)

          major=$(echo $version_name | cut -d'.' -f1)
          minor=$(echo $version_name | cut -d'.' -f2)
          patch=$(echo $version_name | cut -d'.' -f3)

          # Increment build number always
          new_build=$((build_number + 1))

          # Bump version based on input
          case "${{ github.event.inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            build)
              # Only build number increments
              ;;
          esac

          new_version="${major}.${minor}.${patch}"
          full_version="${new_version}+${new_build}"

          echo "New version: $full_version"

          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $full_version/" pubspec.yaml

          # Output for other jobs
          echo "version=$new_version" >> $GITHUB_OUTPUT
          echo "build_number=$new_build" >> $GITHUB_OUTPUT
          echo "full_version=$full_version" >> $GITHUB_OUTPUT

      - name: Commit version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pubspec.yaml
          git commit -m "chore: bump version to ${{ steps.bump.outputs.full_version }} [skip ci]"
          git push

  deploy-ios:
    name: Deploy iOS
    needs: version-bump
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/private_keys
          echo "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APPSTORE_API_KEY_ID }}.p8

      - name: Create .env.production
        run: |
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production

      - name: Build iOS
        run: |
          flutter build ios --release \
            --dart-define-from-file=.env.production \
            --build-name=${{ needs.version-bump.outputs.version }} \
            --build-number=${{ needs.version-bump.outputs.build_number }}

      - name: Deploy to App Store
        working-directory: ios
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ~/private_keys/AuthKey_${{ secrets.APPSTORE_API_KEY_ID }}.p8
        run: |
          # Determine which lane to use based on track
          case "${{ github.event.inputs.track }}" in
            internal|beta)
              bundle exec fastlane beta
              ;;
            production)
              bundle exec fastlane release
              ;;
          esac

  deploy-android:
    name: Deploy Android
    needs: version-bump
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Create .env.production
        run: |
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production

      - name: Setup Android signing
        run: |
          # Decode keystore from base64
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks

          # Create key.properties
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=../upload-keystore.jks
          EOF

      - name: Setup Play Store credentials
        run: |
          echo '${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}' > android/android-secret.json

      - name: Build Android
        run: |
          flutter build appbundle --release \
            --dart-define-from-file=.env.production \
            --build-name=${{ needs.version-bump.outputs.version }} \
            --build-number=${{ needs.version-bump.outputs.build_number }}

      - name: Deploy to Play Store
        working-directory: android
        run: |
          # Determine which lane to use based on track
          case "${{ github.event.inputs.track }}" in
            internal)
              bundle exec fastlane internal
              ;;
            beta)
              bundle exec fastlane beta
              ;;
            production)
              bundle exec fastlane deploy
              ;;
          esac

  create-release-tag:
    name: Create Release Tag
    needs: [version-bump, deploy-ios, deploy-android]
    if: always() && needs.version-bump.result == 'success' && (needs.deploy-ios.result == 'success' || needs.deploy-ios.result == 'skipped') && (needs.deploy-android.result == 'success' || needs.deploy-android.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Create and push tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          TAG="v${{ needs.version-bump.outputs.version }}+${{ needs.version-bump.outputs.build_number }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          echo "Created tag: $TAG"
